from __future__ import print_function
import pytest

from .runner import get_nn_runners

default_rnns = ['cudnn', 'aten', 'jit', 'jit_premul', 'jit_premul_bias', 'jit_simple',
                         'jit_multilayer', 'py']
default_cnns = ['resnet18', 'resnet18_jit', 'resnet50', 'resnet50_jit']
all_nets = default_rnns + default_cnns

"""
TODO
    - try custom 'cuda event' timer function for pytest-benchmark
    - group 'rnn' and 'cnn'
    - handle original script's arguments
    - add way to customize the nets that get generated by parametrize
    - don't forget to deal with pytest-benchmark pip requirement eventually
"""

def pytest_generate_tests(metafunc):
    if metafunc.cls.__name__ == "TestBenchNetwork":
        metafunc.parametrize('net_name', all_nets, scope="class")

@pytest.fixture(scope='class')
def modeldef(request, net_name):
    name, rnn_creator, context = get_nn_runners(net_name)[0]
    creator_args = creator_args = {
        'seqLength': 100, 'numLayers': 1,
        'inputSize': 512, 'hiddenSize': 512,
        'miniBatch': 64, 'device': 'cuda', 'seed': None
    }
    return rnn_creator(**creator_args)

@pytest.mark.benchmark(
    warmup=True,
    warmup_iterations=5,
    disable_gc=True,
    max_time=0.3,
)
class TestBenchNetwork:
    def test_forward(self, modeldef, benchmark):
        forward_output = benchmark(modeldef.forward, *modeldef.inputs)

    def test_backward(self, modeldef, benchmark):
        forward_output = modeldef.forward(*modeldef.inputs)
        if modeldef.backward_setup is not None:
            backward_input = modeldef.backward_setup(forward_output)
        else:
            backward_input = forward_output


        if modeldef.backward is not None:
            benchmark(modeldef.backward, *backward_input, retain_graph=True)

        if modeldef.backward is not None:
            for param in modeldef.params:
                assert param.grad is not None
                param.grad.data.zero_()
